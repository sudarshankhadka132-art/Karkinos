<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Karkinos Intelligence Search</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        color: #1b1b1d;
        background-color: #f5f5f7;
      }

      body {
        margin: 0;
        padding: 2rem 1rem;
        display: flex;
        justify-content: center;
      }

      main {
        width: min(960px, 100%);
        background: white;
        border-radius: 16px;
        padding: 2rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      }

      h1 {
        margin-top: 0;
        font-size: 1.8rem;
      }

      form {
        display: flex;
        gap: 1rem;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
        align-items: center;
      }

      input[type="text"] {
        flex: 1 1 320px;
        padding: 0.75rem 1rem;
        border: 1px solid #ccd0d5;
        border-radius: 8px;
        font-size: 1rem;
      }

      input[type="number"] {
        width: 80px;
        padding: 0.75rem 1rem;
        border: 1px solid #ccd0d5;
        border-radius: 8px;
        font-size: 1rem;
      }

      button {
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        border: none;
        font-weight: 600;
        background-color: #0b7285;
        color: white;
        cursor: pointer;
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .result-card {
        border: 1px solid #e1e4e8;
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 1rem;
        background: #fafbfc;
      }

      .result-card h3 {
        margin: 0 0 0.5rem;
        font-size: 1.1rem;
      }

      .result-meta {
        color: #555;
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
      }

      .empty-state {
        text-align: center;
        padding: 2rem;
        color: #666;
      }
    </style>
  </head>
  <body>
    <main>
      <h1>Intelligence Search</h1>
      <form id="search-form">
        <input
          type="text"
          id="search-query"
          name="query"
          placeholder="Search for therapies, biomarkers, trials…"
          required
        />
        <input type="number" id="search-top-k" name="top_k" min="1" max="50" value="5" />
        <button type="submit" id="search-submit">Search</button>
      </form>
      <section id="results" class="empty-state">
        Enter a query to find the most relevant knowledge chunks.
      </section>
    </main>
    <script>
      const form = document.getElementById("search-form");
      const resultsContainer = document.getElementById("results");
      const submitButton = document.getElementById("search-submit");

      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        const formData = new FormData(form);
        const query = formData.get("query");
        const topK = Number(formData.get("top_k")) || 5;

        submitButton.disabled = true;
        resultsContainer.classList.remove("empty-state");
        resultsContainer.textContent = "Searching…";

        try {
          const response = await fetch("/search", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ query, top_k: topK }),
          });

          if (!response.ok) {
            throw new Error(`Search failed with status ${response.status}`);
          }

          const payload = await response.json();
          if (!payload.results || payload.results.length === 0) {
            resultsContainer.classList.add("empty-state");
            resultsContainer.textContent = "No results matched your search.";
            return;
          }

          resultsContainer.innerHTML = payload.results
            .map(
              (result) => `
                <article class="result-card" data-testid="search-result">
                  <h3>${result.document.title || "Untitled document"}</h3>
                  <div class="result-meta">
                    Source: <strong>${result.document.source}</strong>
                    ${result.document.cancer_type ? ` · Cancer: <strong>${result.document.cancer_type}</strong>` : ""}
                    · Score: ${result.score.toFixed(3)}
                  </div>
                  <p>${result.text}</p>
                </article>
              `
            )
            .join("");
        } catch (error) {
          resultsContainer.classList.add("empty-state");
          resultsContainer.textContent = error.message;
        } finally {
          submitButton.disabled = false;
        }
      });
    </script>
  </body>
</html>
